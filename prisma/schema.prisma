generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL") // Prisma Accelerate 사용 시 활성화
}

enum UserRole {
  AUTHOR
  EDITOR
  ADMIN
}

enum AgeRating {
  ALL
  FIFTEEN
  NINETEEN
}

enum WorkStatus {
  // 기존 값 (호환성 유지)
  PREPARING       // @deprecated - REGISTERED로 대체
  ONGOING         // @deprecated - TRANSLATING으로 대체
  // 새 값
  REGISTERED      // 등록됨 (원문 등록 대기)
  TRANSLATING     // 번역 진행중
  PROOFREADING    // 윤문 진행중
  COMPLETED       // 완료
}

enum OriginalStatus {
  ONGOING         // 원작 연재중
  COMPLETED       // 원작 완결
}

enum SourceLanguage {
  ZH              // 중국어
  JA              // 일본어
  EN              // 영어
  OTHER           // 기타
}

enum ChapterStatus {
  PENDING
  TRANSLATING
  TRANSLATED
  REVIEWING
  EDITED
  APPROVED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  name          String
  role          UserRole  @default(AUTHOR)
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  works         Work[]    @relation("AuthorWorks")
  editingWorks  Work[]    @relation("EditorWorks")
  accounts      Account[]
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@unique([email, token])
}

model Work {
  id              String         @id @default(cuid())
  titleKo         String
  titleOriginal   String
  publisher       String
  ageRating       AgeRating      @default(ALL)
  status          WorkStatus     @default(REGISTERED)
  coverImage      String?
  synopsis        String         @db.Text
  genres          String[]

  // 원작 정보
  originalStatus  OriginalStatus @default(COMPLETED)
  sourceLanguage  SourceLanguage @default(ZH)
  expectedChapters Int?          // 예상 총 회차 (완결 작품은 확정)

  // 원작 플랫폼
  platformName    String?
  platformUrl     String?
  publishedAt     DateTime?
  totalChapters   Int            @default(0)

  authorId        String
  author          User           @relation("AuthorWorks", fields: [authorId], references: [id])

  editorId        String?
  editor          User?          @relation("EditorWorks", fields: [editorId], references: [id])

  chapters        Chapter[]
  glossary        GlossaryItem[]
  creators        Creator[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([authorId])
  @@index([editorId])
  @@index([status])
  @@index([updatedAt])
}

model Creator {
  id      String @id @default(cuid())
  name    String
  role    String
  workId  String
  work    Work   @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@index([workId])
}

model Chapter {
  id                String        @id @default(cuid())
  number            Int
  title             String?
  originalContent   String        @db.Text
  translatedContent String?       @db.Text
  editedContent     String?       @db.Text
  status            ChapterStatus @default(PENDING)
  wordCount         Int           @default(0)

  // 번역 중간 저장 메타데이터 (JSON)
  // { lastSavedChunk: number, totalChunks: number, partialResults: string[] }
  translationMeta   Json?

  workId            String
  work              Work          @relation(fields: [workId], references: [id], onDelete: Cascade)

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@unique([workId, number])
  @@index([workId])
  @@index([status])
  @@index([workId, status])
}

model GlossaryItem {
  id          String  @id @default(cuid())
  original    String
  translated  String
  category    String?
  note        String?

  workId      String
  work        Work    @relation(fields: [workId], references: [id], onDelete: Cascade)

  @@unique([workId, original])
  @@index([workId])
}

// ============================================
// 번역 로그 및 모니터링
// ============================================

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

enum LogCategory {
  TRANSLATION      // 번역 관련
  API_CALL         // Gemini API 호출
  RATE_LIMIT       // Rate limit 관련
  CHUNK            // 청크 처리
  CHAPTER          // 챕터 처리
  JOB              // 작업 전체
  SYSTEM           // 시스템
}

model TranslationLog {
  id          String      @id @default(cuid())
  level       LogLevel    @default(INFO)
  category    LogCategory @default(TRANSLATION)

  // 관련 엔티티
  jobId       String?
  workId      String?
  chapterId   String?
  chapterNum  Int?
  chunkIndex  Int?

  // 사용자 정보
  userId      String?
  userEmail   String?

  // 로그 내용
  message     String      @db.Text
  errorCode   String?     // TranslationError 코드
  errorStack  String?     @db.Text
  metadata    Json?       // 추가 메타데이터 (JSON)

  // 성능 메트릭
  durationMs  Int?        // 소요 시간
  retryCount  Int?        // 재시도 횟수

  // 환경 정보
  clientIp    String?
  userAgent   String?

  createdAt   DateTime    @default(now())

  @@index([level])
  @@index([category])
  @@index([jobId])
  @@index([workId])
  @@index([userId])
  @@index([errorCode])
  @@index([createdAt])
  @@index([level, createdAt])
  @@index([category, createdAt])      // 어드민 로그 필터링용
  @@index([level, category])          // 복합 필터링용
  @@index([workId, createdAt])        // 작품별 로그 조회용
}

// 활성 번역 작업 (서버리스 환경 지원 - DB 기반)
model ActiveTranslationJob {
  id                String    @id @default(cuid())
  jobId             String    @unique  // 클라이언트 식별용 ID

  workId            String
  workTitle         String
  userId            String
  userEmail         String?

  // 상태
  status            String    @default("PENDING")  // PENDING, IN_PROGRESS, PAUSED, COMPLETED, FAILED
  isPauseRequested  Boolean   @default(false)

  // 진행률
  totalChapters     Int
  completedChapters Int       @default(0)
  failedChapters    Int       @default(0)

  // 현재 진행 중인 챕터 정보
  currentChapterNum Int?
  currentChunkIndex Int?
  totalChunks       Int?

  // 챕터별 상태 (JSON)
  // [{ number, chapterId, status, currentChunk, totalChunks, error? }]
  chaptersProgress  Json?

  // 에러 정보
  errorMessage      String?   @db.Text

  // 시간 정보
  startedAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([workId, status])  // 작품당 하나의 활성 작업만
  @@index([workId])
  @@index([userId])
  @@index([status])
  @@index([updatedAt])
}

// 번역 작업 히스토리 (영구 저장)
model TranslationJobHistory {
  id                String    @id @default(cuid())
  jobId             String    @unique  // translationManager의 jobId

  workId            String
  workTitle         String
  userId            String
  userEmail         String?

  status            String    // COMPLETED, FAILED, PAUSED
  totalChapters     Int
  completedChapters Int
  failedChapters    Int

  // 실패 정보
  errorMessage      String?   @db.Text
  failedChapterNums Int[]     // 실패한 챕터 번호 목록

  // 시간 정보
  startedAt         DateTime
  completedAt       DateTime?
  durationMs        Int?      // 전체 소요 시간

  createdAt         DateTime  @default(now())

  @@index([workId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}
